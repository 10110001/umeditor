<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <link rel="stylesheet" href="../../third-party/mathquill/mathquill.css"/>
    <style>
        html, body, .main{
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        .main{
            width:1024px;
            height:1024px;
        }
        .mathquill-editable{
            border: 0px;
            padding: 0px;
            margin:4px;
        }
    </style>
</head>
<body>

<div class="main">
    <div class="mathquill-textbox mathquill-editable"></div>
</div>

<script src="../../_examples/jquery.js"></script>
<script src="../../third-party/mathquill/mathquill.js"></script>
<script>
    $(function(){

        var UM = parent.UM,
            $iframe = $(getSelfIframe()),
            editorId = $iframe.parents('.edui-body-container').attr('id'),
            editor = UM.getEditor(editorId),
            timer;

        /* 获得当前公式所在的iframe节点 */
        function getSelfIframe(){
            var iframes = parent.document.getElementsByTagName('iframe');
            for (var key in iframes) {
                if (iframes[key].contentWindow == window) {
                    return iframes[key];
                }
            }
            return null;
        };
        /* 获得当前url上的hash存储的参数值 */
        function getLatex() {
            return $iframe.attr('data-latex') || '';
        }
        /* 保存场景 */
        function saveScene(){
            if(!timer) {
                timer = setTimeout(function(){
                    editor.fireEvent('savescene');
                    editor.fireEvent('contentchange');
                    timer = null;
                }, 1000);
            }
        }

        /* 公式 */
        var Formula = function(){
            var _this = this,
                latex = getLatex();

            this.$mathquill = $('.mathquill-editable').mathquill('latex', latex);
//            this.$mathquill.find('textarea').on('focus', function(){
//                _this.focus();
//                console.log('focus');
//            }).on('blur', function(){
//                _this.blur();
//                console.log('blur');
//            });

            this.$mathquill.on('keydown', function(){
                _this.updateIframe();
                console.log('keydown');
            }).on('keyup', function(){
                _this.updateIframe();
                console.log('keyup');
            });

            $(document.body).on('click', function(){
                _this.focus();
            });
            editor.$body.on('click', function(){
                _this.blur();
            });

            this.$mathquill.parent().find('.hasCursor').removeClass('hasCursor');

            setTimeout(function(){
                _this.updateIframe();
            }, 300);
        };
        Formula.prototype = {
            focus:function(){
                editor.$body.find('iframe').not($iframe).each(function(k, v){
                    v.contentWindow.formula.blur();
                });
                $iframe.addClass('edui-formula-active');
                this.$mathquill.focus();
                editor.setDisabled('formula');
                editor.blur();
            },
            blur:function(){
                $iframe.removeClass('edui-formula-active');
                this.removeCursor();
                editor.setEnabled();
            },
            removeCursor: function(){
                this.$mathquill.find('span.cursor').hide();
                this.$mathquill.parent().find('.hasCursor').removeClass('hasCursor');
            },
            updateIframe: function(){
                $iframe.width(this.$mathquill.width()+8).height(this.$mathquill.height()+8);
                this.redraw();
                var latex = $iframe.attr('data-latex'),
                    newLatex = this.getLatex();
                if(latex != newLatex) {
                    $iframe.attr('data-latex', this.getLatex());
                    saveScene();
                }
            },
            insertLatex: function(latex){
                this.$mathquill.mathquill('write', latex);
                this.updateIframe();
                this.removeCursor();
                //this.refresh();
                editor.blur();
            },
            setLatex: function(latex){
                this.$mathquill.mathquill('latex', latex);
                this.updateIframe();
            },
            getLatex: function(){
                return this.$mathquill.mathquill('latex');
            },
            redraw: function(){
                return this.$mathquill.mathquill('redraw');
            },
            refresh: function(){
                var latex = this.getLatex();
                return this.$mathquill.mathquill('revert').text(latex).mathquill('editable');
            }
        }

        /* 绑定到window上，给上级window调用 */
        window.formula = new Formula();
    });
</script>
</body>
</html>